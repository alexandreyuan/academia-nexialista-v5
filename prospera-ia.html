<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Método Prospera-IA | Academia Nexialista</title>
    
    <!-- Favicons -->
    <link rel="icon" type="image/png" href="assets/logo-nexialista.png">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'nexus-deep': '#0A0A0A',
                        'gold-experience': '#D4AF37',
                        'nexus-power': '#1C1C1C',
                        'digital-clarity': '#F5F5F5',
                        'gold-legacy': '#B8860B',
                        'purple-wisdom': '#6B46C1',
                        'emerald-growth': '#10B981',
                        'sapphire-vision': '#3B82F6',
                        'ruby-passion': '#EF4444'
                    },
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif'],
                        'playfair': ['Playfair Display', 'serif']
                    }
                }
            }
        }
    </script>

    <style>
        .agent-glow {
            animation: pulse 3s infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
            }
            50% {
                box-shadow: 0 0 40px rgba(212, 175, 55, 0.6);
            }
        }
        
        .chat-container {
            height: calc(100vh - 200px);
            max-height: 600px;
        }
        
        .typing-dots::after {
            content: '...';
            animation: dots 1.5s infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .method-step {
            position: relative;
            padding-left: 40px;
        }

        .method-step::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 30px;
            bottom: -30px;
            width: 2px;
            background: linear-gradient(to bottom, #D4AF37, transparent);
        }

        .method-step:last-child::before {
            display: none;
        }

        .shared-memory-indicator {
            animation: sync-pulse 2s infinite;
        }

        @keyframes sync-pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
    </style>
</head>
<body class="font-inter bg-gradient-to-br from-nexus-deep via-nexus-power to-nexus-deep text-digital-clarity min-h-screen">

    <!-- Navigation -->
    <nav class="bg-nexus-power/90 backdrop-blur-sm border-b border-gold-experience/30 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-3">
                    <button onclick="goBack()" class="p-2 hover:bg-gold-experience/10 rounded-lg transition-colors">
                        <i class="fas fa-arrow-left text-gold-experience"></i>
                    </button>
                    <img src="assets/logo-nexialista.png" alt="Prospera-IA" class="w-10 h-10 rounded-full">
                    <div>
                        <span class="font-playfair font-bold text-lg text-gold-experience">Método Prospera-IA</span>
                        <span class="block text-xs text-digital-clarity/60">Sistema de 4 Agentes Integrados</span>
                    </div>
                </div>
                
                <!-- Memory Sync Indicator -->
                <div class="flex items-center space-x-4">
                    <div class="hidden sm:flex items-center space-x-2 px-3 py-1 bg-purple-wisdom/10 border border-purple-wisdom/30 rounded-full">
                        <div class="w-2 h-2 bg-purple-wisdom rounded-full shared-memory-indicator"></div>
                        <span class="text-xs font-medium text-purple-wisdom">Memória Compartilhada Ativa</span>
                    </div>
                </div>
            </div>
        </div>
    </nav>
<script>
  // Menu inteligente (Prospera-IA): abrir editor se admin; senão abrir login admin
  (function(){
    function isAdmin(){
      try {
        if (window.NexialistaAuth && typeof window.NexialistaAuth.isAdmin === 'function') {
          return window.NexialistaAuth.isAdmin();
        }
        const s = localStorage.getItem('nexialista_admin_session');
        if (!s) return false;
        const session = JSON.parse(s);
        return session && session.expires && session.expires > Date.now();
      } catch(e){ return false; }
    }

    function navigateSmart(){
      const target = isAdmin() ? 'custom-agents.html' : 'admin-auth.html';
      window.location.href = target;
    }

    document.addEventListener('DOMContentLoaded', function(){
      const createLink = document.getElementById('create-agents-link');
      if (createLink) createLink.addEventListener('click', function(e){ e.preventDefault(); navigateSmart(); });
    });
  })();
</script>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Header Section -->
        <div class="text-center mb-12">
            <h1 class="text-4xl md:text-5xl font-playfair font-bold mb-4">
                <span class="bg-gradient-to-r from-gold-experience via-purple-wisdom to-emerald-growth bg-clip-text text-transparent">
                    🚀 Método Prospera-IA
                </span>
            </h1>
            <p class="text-lg text-digital-clarity/80 max-w-3xl mx-auto mb-6">
                Sistema revolucionário de 4 agentes com memória compartilhada para transformar sua jornada empreendedora através da inteligência artificial nexialista
            </p>
            
            <!-- Como Funciona o Método removido conforme solicitação -->

            <!-- Sumário Executivo - Versão 4.0 -->
            <div class="mt-6 grid gap-4 md:grid-cols-3">
                <div class="flex items-center justify-center md:justify-start">
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs bg-purple-wisdom/20 text-purple-wisdom border border-purple-wisdom/30">Versão 4.0</span>
                </div>
                <div class="flex items-center justify-center">
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs bg-emerald-growth/20 text-emerald-growth border border-emerald-growth/30">Público: 45–65 anos</span>
                </div>
                <div class="flex items-center justify-center md:justify-end">
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs bg-sapphire-vision/20 text-sapphire-vision border border-sapphire-vision/30">Jornada: 70–80 horas</span>
                </div>
            </div>
            <!-- Link para PDF removido a pedido do Yuan em 2025-09-26 -->
        </div>

        <!-- Fluxo dos Agentes do Método -->
        <section class="mb-10">
            <div class="bg-nexus-power/50 border border-gold-experience/20 rounded-2xl p-6 lg:p-8">
                <div class="text-center mb-6">
                    <h2 class="text-2xl md:text-3xl font-playfair font-bold text-digital-clarity mb-3">
                        🔄 <span class="text-gold-experience">Fluxo Integrado dos Agentes</span>
                    </h2>
                    <p class="text-digital-clarity/70 max-w-3xl mx-auto">
                        Os 4 agentes trabalham em sequência com memória compartilhada, construindo sobre os insights anteriores
                    </p>
                </div>
                
                <div class="grid lg:grid-cols-4 gap-4 max-w-5xl mx-auto">
                    <div class="text-center">
                        <div class="w-14 h-14 bg-purple-wisdom/20 rounded-full flex items-center justify-center mx-auto mb-3">
                            <span class="text-2xl">🔮</span>
                        </div>
                        <h3 class="font-semibold text-purple-wisdom mb-1">1. Oráculo</h3>
                        <p class="text-xs text-digital-clarity/70">Autodescoberta: Ikigai e Zona de Gênio</p>
                    </div>
                    
                    <div class="flex items-center justify-center">
                        <i class="fas fa-arrow-right text-gold-experience/50 text-xl"></i>
                    </div>
                    
                    <div class="text-center">
                        <div class="w-14 h-14 bg-sapphire-vision/20 rounded-full flex items-center justify-center mx-auto mb-3">
                            <span class="text-2xl">🧩</span>
                        </div>
                        <h3 class="font-semibold text-sapphire-vision mb-1">2. Nexus</h3>
                        <p class="text-xs text-digital-clarity/70">Conexões e Síntese Estratégica</p>
                    </div>
                    
                    <div class="flex items-center justify-center">
                        <i class="fas fa-arrow-right text-gold-experience/50 text-xl"></i>
                    </div>
                    
                    <div class="text-center">
                        <div class="w-14 h-14 bg-emerald-growth/20 rounded-full flex items-center justify-center mx-auto mb-3">
                            <span class="text-2xl">⚗️</span>
                        </div>
                        <h3 class="font-semibold text-emerald-growth mb-1">3. Alquimista</h3>
                        <p class="text-xs text-digital-clarity/70">Estruturação do Conhecimento</p>
                    </div>
                    
                    <div class="flex items-center justify-center">
                        <i class="fas fa-arrow-right text-gold-experience/50 text-xl"></i>
                    </div>
                    
                    <div class="text-center">
                        <div class="w-14 h-14 bg-ruby-passion/20 rounded-full flex items-center justify-center mx-auto mb-3">
                            <span class="text-2xl">🏗️</span>
                        </div>
                        <h3 class="font-semibold text-ruby-passion mb-1">4. Arquiteto</h3>
                        <p class="text-xs text-digital-clarity/70">Implementação e Lançamento</p>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Agents Section Title -->
        <div class="text-center mb-8">
            <h2 class="text-2xl md:text-3xl font-playfair font-bold text-digital-clarity mb-2">
                <i class="fas fa-robot text-gold-experience mr-2"></i>
                Agentes do Método
            </h2>
            <p class="text-digital-clarity/70">Clique em um agente para iniciar sua jornada</p>
        </div>
        
        <!-- Agents Grid (Dynamic) -->
        <div id="prospera-agents-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
        
        <!-- Empty State -->
        <div id="prospera-empty" class="hidden bg-nexus-power/60 border border-gold-experience/20 rounded-2xl p-8 text-center">
            <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-nexus-power flex items-center justify-center">
                <i class="fas fa-robot text-2xl text-gold-experience/60"></i>
            </div>
            <h3 class="font-playfair text-xl font-bold mb-2">Nenhum agente do Prospera-IA disponível</h3>
            <p class="text-digital-clarity/70 mb-4">Crie agentes em "Agentes IA" e marque o produto como Prospera-IA para aparecerem aqui.</p>
            <a href="#" class="inline-block bg-gold-experience hover:bg-gold-legacy text-nexus-deep px-5 py-2 rounded-lg font-semibold transition-colors" id="create-agents-link">
                <i class="fas fa-plus mr-2"></i>Criar agentes
            </a>
        </div>

        <!-- Upgrade Banner (dinâmico) -->
        <div id="prospera-upgrade-banner" class="hidden mt-6 p-4 bg-yellow-900/30 border border-yellow-500/30 rounded-xl text-yellow-100 text-sm"></div>

        <!-- Shared Memory Status -->
        <div class="mt-8 bg-nexus-power/50 backdrop-blur-sm border border-gold-experience/20 rounded-2xl p-6">
            <h2 class="text-lg font-playfair font-bold text-gold-experience mb-4">
                <i class="fas fa-database mr-2"></i>Status da Memória Compartilhada
            </h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="text-center">
                    <div id="oracle-memory-status" class="text-2xl font-bold text-purple-wisdom mb-1">0</div>
                    <div class="text-xs text-digital-clarity/60">Interações Oráculo</div>
                </div>
                <div class="text-center">
                    <div id="nexus-memory-status" class="text-2xl font-bold text-sapphire-vision mb-1">0</div>
                    <div class="text-xs text-digital-clarity/60">Interações Nexus</div>
                </div>
                <div class="text-center">
                    <div id="alchemist-memory-status" class="text-2xl font-bold text-emerald-growth mb-1">0</div>
                    <div class="text-xs text-digital-clarity/60">Interações Alquimista</div>
                </div>
                <div class="text-center">
                    <div id="architect-memory-status" class="text-2xl font-bold text-ruby-passion mb-1">0</div>
                    <div class="text-xs text-digital-clarity/60">Interações Arquiteto</div>
                </div>
            </div>
        </div>
    </main>

    <!-- Chat Modal -->
    <div id="prospera-chat-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-nexus-power border border-gold-experience/30 rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
                
                <!-- Modal Header -->
                <div id="chat-header" class="border-b border-gold-experience/30 p-4 flex justify-between items-center">
                    <div class="flex items-center space-x-3">
                        <div id="agent-icon" class="w-10 h-10 rounded-full flex items-center justify-center text-xl">
                            🤖
                        </div>
                        <div>
                            <h3 id="agent-title" class="font-playfair font-bold">Agente</h3>
                            <p class="text-xs text-digital-clarity/60">
                                <i class="fas fa-brain mr-1"></i>
                                <span id="memory-context">Memória compartilhada ativa</span>
                            </p>
                        </div>
                    </div>
                    <button onclick="closeProsperaChat()" class="p-2 hover:bg-gold-experience/10 rounded-lg transition-colors">
                        <i class="fas fa-times text-digital-clarity/70"></i>
                    </button>
                </div>
                
                <!-- Chat Messages -->
                <div class="chat-container overflow-y-auto p-4" id="chat-messages">
                    <!-- Messages will appear here -->
                </div>
                
                <!-- Input Area -->
                <div class="border-t border-gold-experience/30 p-4">
                    <div class="flex space-x-2">
                        <input 
                            type="text" 
                            id="prospera-chat-input" 
                            placeholder="Digite sua mensagem..."
                            class="flex-1 bg-nexus-deep border border-gold-experience/30 rounded-lg px-4 py-2 text-digital-clarity placeholder-digital-clarity/50 focus:border-gold-experience focus:outline-none"
                            onkeypress="handleProsperaChatKeypress(event)"
                        >
                        <button 
                            onclick="sendProsperaMessage()"
                            id="send-button"
                            class="bg-gold-experience hover:bg-gold-legacy text-nexus-deep px-4 py-2 rounded-lg font-semibold transition-colors"
                        >
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/utils.js"></script>
    <script src="js/auth-system.js"></script>
    <script src="js/prospera-memory.js"></script>
    <script>
        // ========= Autenticação =========
        let currentUser = null;
        document.addEventListener('DOMContentLoaded', () => {
            // 1) Tentar sessão do Auth System
            if (window.NexialistaAuth && typeof window.NexialistaAuth.isLoggedIn === 'function' && window.NexialistaAuth.isLoggedIn()) {
                currentUser = window.NexialistaAuth.currentUser;
            }
            // 2) Fallback: sessão da Área de Membros (members.js)
            if (!currentUser) {
                try {
                    const session = localStorage.getItem('nexus_member_session') || localStorage.getItem('currentUser');
                    if (session) {
                        const parsed = JSON.parse(session);
                        currentUser = {
                            email: parsed.email || parsed.user?.email,
                            name: parsed.name || parsed.user?.name || 'Membro',
                            subscription: parsed.subscription || parsed.user?.subscription || (parsed.plan === 'nexus-explorer' ? 'basic' : parsed.plan === 'nexus-master' ? 'premium' : parsed.plan === 'nexus-infinity' ? 'vip' : 'basic')
                        };
                    }
                } catch (e) {
                    // ignore parsing errors
                }
            }
            // 3) Se ainda não houver usuário válido, redireciona para login
            if (!currentUser || !currentUser.email) {
                window.location.href = 'members.html';
                return;
            }
            // Instanciar memória compartilhada global do usuário
            try { window.__prosperaMemory = new ProsperaMemorySystem(currentUser.email || 'guest'); } catch(e) { console.warn('Memória não inicializada', e); }
            initProsperaAgents();
        });

        // ========= Config de Provedores =========
        const AI_PROVIDERS = {
            openai: {
                name: 'OpenAI',
                endpoint: 'https://api.openai.com/v1/chat/completions'
            },
            anthropic: {
                name: 'Anthropic',
                endpoint: 'https://api.anthropic.com/v1/messages'
            },
            google: {
                name: 'Google',
                endpoint: 'https://generativelanguage.googleapis.com/v1beta/models/{model}:generateContent'
            },
            openrouter: {
                name: 'OpenRouter',
                endpoint: 'https://openrouter.ai/api/v1/chat/completions'
            }
        };

        let apiKeys = {};
        let prosperaAgentsAll = [];
        let prosperaAgentsList = [];
        let currentChatAgent = null;
        let chatHistory = [];

        async function loadApiKeys() {
            try {
                // Carregar chaves do servidor (fonte de verdade)
                const res = await fetch(buildApiUrl('tables/custom_agents_api_keys'));
                if (res.ok) {
                    const keys = await res.json();
                    apiKeys = {};
                    keys.forEach(k => {
                        if (k.provider && k.api_key) {
                            apiKeys[k.provider] = k.api_key;
                        }
                    });
                    console.log('✅ Chaves de API carregadas do servidor:', Object.keys(apiKeys));
                } else {
                    console.warn('⚠️ Falha ao carregar chaves de API do servidor');
                    apiKeys = {};
                }
            } catch (err) {
                console.warn('⚠️ Erro ao carregar chaves de API:', err);
                apiKeys = {};
            }
        }

        async function initProsperaAgents() {
            await loadApiKeys();
            let list = [];
            // 1) Tentar carregar do servidor (fonte de verdade)
            let __fetchStatus = 'pending'; let __fetchError = ''; let __path = 'relative';
            try {
                const noCache = Date.now();
                let res = await fetch(buildApiUrl(`tables/custom_agents?limit=1000&_=${noCache}`), { cache: 'no-store' });
                if (!res.ok) {
                    // fallback absoluto
                    __path = 'absolute';
                    res = await fetch(buildApiUrl(`/tables/custom_agents?limit=1000&_=${noCache}`), { cache: 'no-store' });
                }
                __fetchStatus = `HTTP ${res.status}`;
                if (res.ok) {
                    const json = await res.json();
                    // O servidor retorna array direto, não { data: [...] }
                    const serverAgents = (Array.isArray(json) ? json : (json.data || [])).filter(a => a && a.product === 'prospera-ia' && (a.is_active !== false));
                    list = serverAgents;
                } else {
                    __fetchError = await res.text();
                }
            } catch (e) { __fetchStatus = 'NETWORK_FAIL'; __fetchError = String(e?.message||e); console.warn('Falha ao carregar agentes do servidor', e); }
            window.__prosperaFetchDiag = { status: __fetchStatus, error: __fetchError, path: __path };
            // Server-only: sem fallback de localStorage
            window.__prosperaAgentsIds = (list || []).map(a => a.id);
            prosperaAgentsAll = list || [];
            prosperaAgentsList = list || [];
            renderProsperaAgents();
            setTimeout(updateDynamicMemoryStatus, 50);
        }

        function renderProsperaAgents() {
            const debug = /[?&]debug=1/.test(window.location.search);

            const grid = document.getElementById('prospera-agents-grid');
            const empty = document.getElementById('prospera-empty');
            const upgradeBanner = document.getElementById('prospera-upgrade-banner');
            const isAdmin = (window.NexialistaAuth && typeof window.NexialistaAuth.isAdmin === 'function' && window.NexialistaAuth.isAdmin()) || false;
            const userLevel = (currentUser && currentUser.subscription) || 'basic';

            const list = prosperaAgentsList || [];
            if (debug) {
                const debugBar = document.getElementById('prospera-upgrade-banner');
                if (debugBar) {
                    const isAdmin = (window.NexialistaAuth && typeof window.NexialistaAuth.isAdmin === 'function' && window.NexialistaAuth.isAdmin()) || false;
                    const diag = window.__prosperaFetchDiag || {};
                    debugBar.classList.remove('hidden');
                    debugBar.innerHTML = `<i class='fas fa-bug mr-2'></i>DEBUG » user=${currentUser?.email||'anon'} plan=${(currentUser&&currentUser.subscription)||'basic'} admin=${isAdmin} | agentes=${list.length} | fetch=${diag.status||'n/a'} ${diag.error?('• '+(diag.error.slice(0,120))):''}`;
                }
            }

            if (!list || list.length === 0) {
                grid.innerHTML = '';
                empty.classList.remove('hidden');
                const link = document.getElementById('create-agents-link');
                if (link) link.classList.toggle('hidden', !isAdmin);
                // Ajustar mensagem para membros (sem sugestão de criação)
                if (!isAdmin) {
                    const title = empty.querySelector('h3');
                    const p = empty.querySelector('p');
                    if (title) title.textContent = 'Em breve';
                    if (p) p.textContent = 'Os agentes do Prospera-IA serão disponibilizados pelo administrador conforme seu plano.';
                }
                if (upgradeBanner) upgradeBanner.classList.add('hidden');
                return;
            }
            empty.classList.add('hidden');

            // Calcular quais estão bloqueados e o menor upgrade necessário
            const locked = list.filter(a => !canAccessAgent(a, userLevel, isAdmin));
            if (locked.length > 0 && upgradeBanner) {
                const minPlan = getMinRequiredPlan(locked);
                const nextLabel = planLabel(minPlan);
                upgradeBanner.innerHTML = `<i class="fas fa-lock mr-2"></i> Alguns agentes estão bloqueados para o seu plano atual. Faça o upgrade para o plano <strong class="text-yellow-300">${nextLabel}</strong> para liberar o acesso.`;
                upgradeBanner.classList.remove('hidden');
            } else if (upgradeBanner) {
                upgradeBanner.classList.add('hidden');
                upgradeBanner.innerHTML = '';
            }

            grid.innerHTML = list.map(agent => {
                const providerName = AI_PROVIDERS[agent.provider]?.name || agent.provider;
                const hasKey = !!apiKeys[agent.provider];
                const plans = normalizePlans(agent);
                const planBadges = (plans || []).map(p => getPlanBadge(p)).join(' ');
                const productTag = getProductBadge(agent.product);
                const canAccess = canAccessAgent(agent, userLevel, isAdmin);
                const requiredPlan = getMinPlan(plans) || 'basic';
                const lockIcon = canAccess ? 'fa-lock-open text-emerald-400' : 'fa-lock text-red-400';
                const buttonState = canAccess && hasKey ? 'bg-gold-experience hover:bg-gold-legacy text-nexus-deep' : 'bg-gray-600 text-white cursor-not-allowed';
                const buttonLabel = !canAccess ? 'Acesso bloqueado' : (hasKey ? 'Conversar agora' : `Configurar API (${providerName||''})`);
                const upgradeMsg = !canAccess ? `<p class="mt-2 text-xs text-red-300"><i class="fas fa-triangle-exclamation mr-1"></i> Faça o upgrade para o plano ${planLabel(requiredPlan)} para ter acesso aos agentes.</p>` : '';
                return `
                <div class="relative bg-nexus-power border-2 border-gold-experience/30 rounded-2xl p-6 hover:scale-[1.01] transition-transform duration-300">
                    <div class="absolute top-4 right-4">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-black/40 border border-white/10 text-white"><i class="fas ${lockIcon} mr-1"></i>${canAccess ? 'Liberado' : 'Bloqueado'}</span>
                    </div>
                    <div class="flex items-start space-x-4">
                        <div class="w-16 h-16 bg-gold-experience/10 rounded-xl flex items-center justify-center text-2xl flex-shrink-0">
                            <i class="${agent.avatar} text-gold-experience"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="font-playfair font-bold text-xl text-gold-experience mb-1 truncate">${agent.name}</h3>
                            <p class="text-xs text-digital-clarity/60 mb-3">${providerName} • ${agent.model}</p>
                            <p class="text-sm text-digital-clarity/80 mb-4 line-clamp-3">${agent.description || 'Agente do Prospera-IA'}</p>
                            <div class="flex flex-wrap gap-2 mb-4">${productTag}${planBadges}</div>
                            <button ${canAccess && hasKey ? '' : 'disabled'} onclick="openProsperaChatCustom('${agent.id}')" class="w-full ${buttonState} py-2 rounded-lg font-semibold transition-colors">
                                <i class="fas fa-comments mr-2"></i>${buttonLabel}
                            </button>
                            ${upgradeMsg}
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function getPlanBadge(level) {
            const map = {
                basic: { c:'blue', icon:'🔰', label:'Básico' },
                premium: { c:'purple', icon:'💎', label:'Premium' },
                vip: { c:'yellow', icon:'🌟', label:'VIP' }
            };
            const x = map[level] || { c:'gray', icon:'❓', label: level };
            return `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-${x.c}-600/20 text-${x.c}-400 border border-${x.c}-500/30">${x.icon} ${x.label}</span>`;
        }

        function getProductBadge(product) {
            const products = {
                'prospera-ia': { icon: '📈', label: 'Prospera-IA', color: 'bg-purple-600/20 text-purple-400 border-purple-500/30' },
                'academia-nexialista': { icon: '🎓', label: 'Academia', color: 'bg-blue-600/20 text-blue-400 border-blue-500/30' },
                'movimento-nexialista': { icon: '🌍', label: 'Movimento', color: 'bg-green-600/20 text-green-400 border-green-500/30' }
            };
            
            const prod = products[product] || { icon: '📦', label: product || 'N/A', color: 'bg-gray-600/20 text-gray-400 border-gray-500/30' };
            return `<span class="inline-flex items-center px-2 py-1 ${prod.color} border text-xs rounded-full">${prod.icon} ${prod.label}</span>`;
        }

        function normalizePlans(agent) {
            const plans = Array.isArray(agent.accessiblePlans) && agent.accessiblePlans.length > 0
                ? agent.accessiblePlans
                : (agent.subscriptionLevel ? [agent.subscriptionLevel] : []);
            // normalizar e remover duplicatas
            return Array.from(new Set((plans || []).map(p => (p||'').toLowerCase())));
        }
        function planRank(level) { return level === 'vip' ? 3 : level === 'premium' ? 2 : level === 'basic' ? 1 : 0; }
        function planLabel(level) { return level === 'vip' ? 'VIP' : level === 'premium' ? 'premium' : 'básico'; }
        function getMinPlan(plans = []) {
            if (!plans || plans.length === 0) return 'basic';
            let min = 'vip';
            plans.forEach(p => { if (planRank(p) < planRank(min)) min = p; });
            return min;
        }
        function canAccessAgent(agent, userLevel = 'basic', isAdmin = false) {
            if (isAdmin) return true;
            const plans = normalizePlans(agent);
            if (!plans || plans.length === 0) return true; // sem restrição explícita
            // Acesso por hierarquia: se o usuário tem nível >= plano mínimo exigido, libera
            const required = getMinPlan(plans);
            return planRank(userLevel) >= planRank(required);
        }
        function getMinRequiredPlan(agents = []) {
            if (!agents || agents.length === 0) return 'basic';
            let min = 'vip';
            agents.forEach(a => {
                const req = getMinPlan(normalizePlans(a));
                if (planRank(req) < planRank(min)) min = req;
            });
            return min;
        }

        // ========= Chat com agentes reais =========
        function openProsperaChatCustom(agentId) {
            const isAdmin = (window.NexialistaAuth && typeof window.NexialistaAuth.isAdmin === 'function' && window.NexialistaAuth.isAdmin()) || false;
            const userLevel = (currentUser && currentUser.subscription) || 'basic';
            const agent = (prosperaAgentsList || []).find(a => a.id === agentId);
            if (!agent) return;
            if (!canAccessAgent(agent, userLevel, isAdmin)) {
                alert(`Acesso bloqueado. Faça o upgrade para o plano ${planLabel(getMinPlan(normalizePlans(agent)))} para conversar com este agente.`);
                return;
            }
            currentChatAgent = agent;
            chatHistory = [];

            // Header
            document.getElementById('agent-icon').innerHTML = `<i class="${agent.avatar} text-gold-experience"></i>`;
            const titleEl = document.getElementById('agent-title');
            if (titleEl) titleEl.textContent = agent.name;

            // Reset chat
            const chatMessages = document.getElementById('chat-messages');
            if (chatMessages) chatMessages.innerHTML = '';

            document.getElementById('prospera-chat-modal').classList.remove('hidden');
            const inputEl = document.getElementById('prospera-chat-input');
            if (inputEl) { inputEl.value = ''; inputEl.focus(); }
        }

        function closeProsperaChat() {
            document.getElementById('prospera-chat-modal').classList.add('hidden');
            currentChatAgent = null;
            chatHistory = [];
        }

        // ======== Memória Compartilhada: atualizar contadores dinâmicos ========
        function updateDynamicMemoryStatus() {
            try {
                if (!currentUser) return;
                const mem = new ProsperaMemorySystem(currentUser.email || 'guest');
                const agentIds = Array.isArray(window.__prosperaAgentsIds) ? window.__prosperaAgentsIds : [];

                const oracleCount = agentIds
                    .filter(id => id.toLowerCase().includes('orac') || id.toLowerCase().includes('oracle'))
                    .reduce((sum, id) => sum + (mem.memory[id]?.length || 0), 0);
                const nexusCount = agentIds
                    .filter(id => id.toLowerCase().includes('nexu'))
                    .reduce((sum, id) => sum + (mem.memory[id]?.length || 0), 0);
                const alchemistCount = agentIds
                    .filter(id => id.toLowerCase().includes('alquim') || id.toLowerCase().includes('alchem'))
                    .reduce((sum, id) => sum + (mem.memory[id]?.length || 0), 0);
                const architectCount = agentIds
                    .filter(id => id.toLowerCase().includes('arquit') || id.toLowerCase().includes('archit'))
                    .reduce((sum, id) => sum + (mem.memory[id]?.length || 0), 0);

                const noData = (oracleCount + nexusCount + alchemistCount + architectCount) === 0;
                if (noData) {
                    const total = mem.memory.sharedContext?.length || 0;
                    const q = Math.floor(total / 4);
                    document.getElementById('oracle-memory-status').textContent = q;
                    document.getElementById('nexus-memory-status').textContent = q;
                    document.getElementById('alchemist-memory-status').textContent = q;
                    document.getElementById('architect-memory-status').textContent = total - 3*q;
                    return;
                }

                document.getElementById('oracle-memory-status').textContent = oracleCount;
                document.getElementById('nexus-memory-status').textContent = nexusCount;
                document.getElementById('alchemist-memory-status').textContent = alchemistCount;
                document.getElementById('architect-memory-status').textContent = architectCount;
            } catch (e) {
                console.warn('Memória dinâmica: erro ao atualizar status', e);
            }
        }

        function handleProsperaChatKeypress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendProsperaMessage();
            }
        }

        async function sendProsperaMessage() {
            const input = document.getElementById('prospera-chat-input');
            const message = input.value.trim();
            if (!message || !currentChatAgent) return;

            addProsperaMessage(message, true);
            try { if (window.__prosperaMemory) window.__prosperaMemory.addMessage(currentChatAgent.id, 'user', message); } catch {}
            input.value = '';

            showTypingIndicator('Pensando...');
            try {
                const response = await callAgentAPI(currentChatAgent, message);
                removeTypingIndicator();
                addProsperaMessage(response, false);
                try { if (window.__prosperaMemory) window.__prosperaMemory.addMessage(currentChatAgent.id, 'assistant', response); } catch {}
                // histórico local
                chatHistory.push(
                    { role: 'user', content: message },
                    { role: 'assistant', content: response }
                );
                // atualizar status de memória
                setTimeout(updateDynamicMemoryStatus, 50);
            } catch (err) {
                removeTypingIndicator();
                addProsperaMessage('❌ Erro ao consultar o provedor: ' + (err.message || 'Falha desconhecida'), false);
            }
        }

        function addProsperaMessage(text, isUser) {
            const chat = document.getElementById('chat-messages');
            const wrap = document.createElement('div');
            wrap.className = `flex ${isUser ? 'justify-end' : 'justify-start'} mb-3`;
            const bubble = document.createElement('div');
            bubble.className = `${isUser ? 'bg-gold-experience text-nexus-deep' : 'bg-nexus-deep border border-gold-experience/30 text-digital-clarity'} rounded-lg px-4 py-2 max-w-[80%] whitespace-pre-wrap`;
            bubble.textContent = text;
            wrap.appendChild(bubble);
            chat.appendChild(wrap);
            chat.scrollTop = chat.scrollHeight;
        }

        function showTypingIndicator(label) {
            const chat = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.id = 'typing-indicator';
            div.className = 'flex justify-start mb-3';
            div.innerHTML = `<div class="bg-nexus-deep border border-gold-experience/30 rounded-lg px-4 py-2"><span class="text-gold-experience/80">${label}</span></div>`;
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }
        function removeTypingIndicator() { const el = document.getElementById('typing-indicator'); if (el) el.remove(); }

        // ========= Contexto Nexialista (injeção cruzada) =========
        const CONTEXT_LIMITS = { maxCharsTotal: 1200, maxPerSnippet: 180, maxOtherAgents: 3, maxOtherSnippets: 2, maxSharedSnippets: 4, maxPrevSnippets: 3 };
        function __truncate(text, max) {
            if (!text) return '';
            const s = String(text).replace(/\s+/g, ' ').trim();
            return s.length > max ? s.slice(0, max - 1) + '…' : s;
        }
        function buildNexialistContext(agentId) {
            try {
                if (!window.__prosperaMemory || !agentId) return '';
                const ctx = window.__prosperaMemory.getAgentContext(agentId);
                const lines = [];
                // Perfil do usuário
                const up = ctx.userProfile || {};
                if (Array.isArray(up.goals) && up.goals.length) {
                    lines.push(`- Perfil > Metas: ${up.goals.slice(-3).join('; ')}`);
                }
                if (Array.isArray(up.challenges) && up.challenges.length) {
                    lines.push(`- Perfil > Desafios: ${up.challenges.slice(-3).join('; ')}`);
                }
                if (Array.isArray(up.strengths) && up.strengths.length) {
                    lines.push(`- Perfil > Forças: ${up.strengths.slice(-3).join('; ')}`);
                }
                // Insights de outros agentes
                const other = ctx.otherAgentInsights || {};
                const otherKeys = Object.keys(other).slice(0, CONTEXT_LIMITS.maxOtherAgents);
                otherKeys.forEach(key => {
                    const snippets = (other[key] || [])
                        .slice(-CONTEXT_LIMITS.maxOtherSnippets)
                        .map(s => __truncate(s, CONTEXT_LIMITS.maxPerSnippet))
                        .join(' | ');
                    if (snippets) lines.push(`- ${key}: ${snippets}`);
                });
                // Contexto compartilhado (últimos eventos relevantes)
                const shared = ctx.recentSharedContext || [];
                if (shared.length) {
                    const shard = shared
                        .slice(-CONTEXT_LIMITS.maxSharedSnippets)
                        .map(m => `${m.role === 'assistant' ? 'A' : 'U'}:${__truncate(m.content, 140)}`)
                        .join(' | ');
                    if (shard) lines.push(`- Contexto compartilhado: ${shard}`);
                }
                // Histórico recente do próprio agente
                const prev = ctx.previousConversations || [];
                if (prev.length) {
                    const prevSum = prev
                        .slice(-CONTEXT_LIMITS.maxPrevSnippets)
                        .map(m => `${m.role === 'assistant' ? 'A' : 'U'}:${__truncate(m.content, 140)}`)
                        .join(' | ');
                    if (prevSum) lines.push(`- Histórico recente (este agente): ${prevSum}`);
                }
                const out = lines.join('\n');
                return __truncate(out, CONTEXT_LIMITS.maxCharsTotal);
            } catch (e) {
                console.warn('Contexto Nexialista: falha ao compor', e);
                return '';
            }
        }

        // ========= Chamadas reais aos provedores =========
        async function callAgentAPI(agent, userMessage) {
            const key = apiKeys[agent.provider];
            if (!key) throw new Error(`Chave API ausente para ${AI_PROVIDERS[agent.provider]?.name || agent.provider}`);

            // FIX: Campo do banco é system_prompt (underscore), não systemPrompt
            let systemPrompt = agent.system_prompt || agent.systemPrompt || '';
            if (agent.knowledge) systemPrompt += `\n\nBase de Conhecimento:\n${agent.knowledge}`;
            // Injetar contexto cruzado (resumido) do ecossistema de agentes e perfil do usuário
            try {
                const crossCtx = buildNexialistContext(agent.id);
                if (crossCtx) {
                    systemPrompt += `\n\nContexto Nexialista (resumo cruzado de agentes e usuário):\n${crossCtx}`;
                }
            } catch (e) { console.warn('Injeção de contexto cruzado falhou', e); }

            const recent = chatHistory.slice(-6);
            return await callProviderAPI(agent.provider, key, systemPrompt, userMessage, {
                model: agent.model,
                temperature: agent.temperature || 0.7,
                maxTokens: agent.max_tokens || agent.maxTokens || 1000,
                history: recent
            });
        }

        async function callProviderAPI(provider, apiKey, systemPrompt, userMessage, options = {}) {
            switch (provider) {
                case 'openai':
                case 'openrouter':
                    return await callOpenAIAPI(AI_PROVIDERS[provider].endpoint, apiKey, systemPrompt, userMessage, options);
                case 'anthropic':
                    return await callAnthropicAPI(apiKey, systemPrompt, userMessage, options);
                case 'google':
                    return await callGoogleAPI(apiKey, systemPrompt, userMessage, options);
                default:
                    throw new Error(`Provedor não suportado: ${provider}`);
            }
        }

        async function callOpenAIAPI(endpoint, apiKey, systemPrompt, userMessage, options) {
            const messages = [ { role:'system', content: systemPrompt }, ... (options.history || []), { role:'user', content: userMessage } ];
            const res = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`,
                    ...(endpoint.includes('openrouter') ? { 'HTTP-Referer': window.location.href, 'X-Title': (document && document.title) ? document.title : 'Prospera-IA' } : {})
                },
                body: JSON.stringify({
                    model: options.model,
                    messages,
                    temperature: options.temperature || 0.7,
                    max_tokens: options.maxTokens || 1000
                })
            });
            if (!res.ok) throw new Error(`${res.status} ${await res.text()}`);
            const data = await res.json();
            return data.choices?.[0]?.message?.content || 'Resposta vazia do provedor';
        }

        async function callAnthropicAPI(apiKey, systemPrompt, userMessage, options) {
            const res = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': apiKey,
                    'anthropic-version': '2023-06-01'
                },
                body: JSON.stringify({
                    model: options.model,
                    max_tokens: options.maxTokens || 1000,
                    temperature: options.temperature || 0.7,
                    system: systemPrompt,
                    messages: [ { role: 'user', content: userMessage } ]
                })
            });
            if (!res.ok) throw new Error(`${res.status} ${await res.text()}`);
            const data = await res.json();
            return data.content?.[0]?.text || 'Resposta vazia do provedor';
        }

        async function callGoogleAPI(apiKey, systemPrompt, userMessage, options) {
            const endpoint = AI_PROVIDERS.google.endpoint.replace('{model}', options.model);
            const prompt = `${systemPrompt}\n\nUser: ${userMessage}\nAssistant:`;
            const res = await fetch(`${endpoint}?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [ { parts: [ { text: prompt } ] } ],
                    generationConfig: {
                        temperature: options.temperature || 0.7,
                        maxOutputTokens: options.maxTokens || 1000
                    }
                })
            });
            if (!res.ok) throw new Error(`${res.status} ${await res.text()}`);
            const data = await res.json();
            return data.candidates?.[0]?.content?.parts?.[0]?.text || 'Resposta vazia do provedor';
        }

        // ========= Navegação =========
        function goBack() { window.location.href = 'members-dashboard.html'; }
    </script>

    <!-- Admin FAB: acesso rápido ao Editor de Agentes -->
    <script>
      (function(){
        function isAdminFounder(){
          try {
            if (window.NexialistaAuth && typeof window.NexialistaAuth.isAdmin==='function' && window.NexialistaAuth.isAdmin()) return true;
            const u = window.NexialistaAuth && window.NexialistaAuth.currentUser;
            if (u && (u.role==='admin' || u.role==='founder' || u.type==='admin')) return true;
            const s = localStorage.getItem('nexialista_admin_session');
            if (s){ const sess = JSON.parse(s); if (sess && sess.expires && sess.expires > Date.now()) return true; }
          } catch(e){}
          return false;
        }
        function mountAdminFab(){
          if (!isAdminFounder()) return;
          if (document.getElementById('admin-fab-editor')) return;
          const btn = document.createElement('button');
          btn.id = 'admin-fab-editor';
          btn.className = 'fixed bottom-6 right-6 z-50 rounded-full shadow-lg bg-gold-experience text-nexus-deep w-12 h-12 flex items-center justify-center hover:bg-gold-legacy transition-colors';
          btn.title = 'Editor de Agentes';
          btn.innerHTML = '<i class="fas fa-wrench"></i>';
          btn.addEventListener('click', function(){ window.location.href = 'custom-agents.html'; });
          document.body.appendChild(btn);
        }
        document.addEventListener('DOMContentLoaded', mountAdminFab);
      })();
    </script>
</body>
</html>