<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="version" content="1.3">
    <title>Academia Nexialista | Agentes de IA</title>
    
    <!-- Favicons -->
    <link rel="icon" type="image/png" href="assets/logo-nexialista.png">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'nexus-deep': '#0A0A0A',
                        'gold-experience': '#D4AF37',
                        'nexus-power': '#1C1C1C',
                        'digital-clarity': '#F5F5F5',
                        'gold-legacy': '#B8860B'
                    },
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif'],
                        'playfair': ['Playfair Display', 'serif']
                    }
                }
            }
        }
    </script>

    <style>
        .agent-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .agent-card:not(.locked):hover {
            transform: translateY(-5px) scale(1.02);
        }
        
        .agent-card.locked {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        .lock-overlay {
            background: rgba(10, 10, 10, 0.8);
            backdrop-filter: blur(4px);
        }

        .chat-container {
            height: calc(100vh - 200px);
            max-height: 600px;
        }

        .typing-indicator::after {
            content: '...';
            animation: typing 1.5s infinite;
        }

        @keyframes typing {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
    </style>
</head>
<body class="font-inter bg-nexus-deep text-digital-clarity min-h-screen">

    <!-- Navigation -->
    <nav class="bg-nexus-power border-b border-gold-experience/30 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-3">
                    <button onclick="goBack()" class="p-2 hover:bg-gold-experience/10 rounded-lg transition-colors">
                        <i class="fas fa-arrow-left text-gold-experience"></i>
                    </button>
                    <img src="assets/logo-nexialista.png" alt="Academia Nexialista" class="w-10 h-10 rounded-full">
                    <div>
                        <span class="font-playfair font-bold text-lg text-gold-experience">Academia Nexialista</span>
                        <span class="block text-xs text-digital-clarity/60">Agentes de IA Especializados</span>
                    </div>
                </div>
                
                <!-- User Info -->
                <div class="flex items-center space-x-4">
                    <div class="hidden sm:flex items-center space-x-2 px-3 py-1 bg-gold-experience/10 border border-gold-experience/30 rounded-full">
                        <i class="fas fa-crown text-gold-experience text-sm"></i>
                        <span id="user-plan" class="text-sm font-medium text-gold-experience">Carregando...</span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Header -->
        <div class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-playfair font-bold mb-4">
                <span class="bg-gradient-to-r from-gold-experience to-gold-legacy bg-clip-text text-transparent">
                    üß† Agentes Nexialistas
                </span>
            </h1>
            <p class="text-lg text-digital-clarity/70 max-w-3xl mx-auto">
                Cada agente foi treinado com pensamento transmatem√°tico para oferecer perspectivas √∫nicas e insights profundos
            </p>
        </div>

        <!-- Agents Grid -->
        <div id="agents-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

        <!-- Empty State (server-first) -->
        <div id="empty-state" class="hidden bg-nexus-power/60 border border-gold-experience/20 rounded-2xl p-8 text-center">
            <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-nexus-power flex items-center justify-center">
                <i class="fas fa-robot text-2xl text-gold-experience/60"></i>
            </div>
            <h3 class="font-playfair text-xl font-bold mb-2">Em breve</h3>
            <p class="text-digital-clarity/70 mb-4">Os agentes da Academia ser√£o disponibilizados pelo administrador conforme seu plano.</p>
            <a href="#" class="inline-block bg-gold-experience hover:bg-gold-legacy text-nexus-deep px-5 py-2 rounded-lg font-semibold transition-colors" id="create-academy-agents-link">
                <i class="fas fa-plus mr-2"></i>Criar agentes
            </a>
        </div>

        <!-- Loading State -->
        <div id="loading-agents" class="text-center py-12">
            <div class="inline-flex items-center space-x-2">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gold-experience"></div>
                <span class="text-digital-clarity/70">Carregando agentes...</span>
            </div>
        </div>
    </main>

    <!-- Chat Modal -->
    <div id="chat-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-nexus-power border border-gold-experience/30 rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
                
                <!-- Modal Header -->
                <div class="border-b border-gold-experience/30 p-4 flex justify-between items-center">
                    <div class="flex items-center space-x-3">
                        <div id="agent-avatar" class="w-10 h-10 rounded-full bg-gradient-to-br from-gold-experience to-gold-legacy flex items-center justify-center">
                            <i class="fas fa-robot text-nexus-deep"></i>
                        </div>
                        <div>
                            <h3 id="agent-name" class="font-playfair font-bold text-gold-experience">Agente</h3>
                            <p id="agent-specialty" class="text-xs text-digital-clarity/60">Especialidade</p>
                        </div>
                    </div>
                    <button onclick="closeChat()" class="p-2 hover:bg-gold-experience/10 rounded-lg transition-colors">
                        <i class="fas fa-times text-digital-clarity/70"></i>
                    </button>
                </div>
                
                <!-- Chat Container -->
                <div class="chat-container overflow-y-auto p-4" id="chat-messages">
                    <!-- Messages will appear here -->
                </div>
                
                <!-- Input Area -->
                <div class="border-t border-gold-experience/30 p-4">
                    <div class="flex space-x-2">
                        <input 
                            type="text" 
                            id="chat-input" 
                            placeholder="Digite sua mensagem..."
                            class="flex-1 bg-nexus-deep border border-gold-experience/30 rounded-lg px-4 py-2 text-digital-clarity placeholder-digital-clarity/50 focus:border-gold-experience focus:outline-none"
                            onkeypress="handleChatKeypress(event)"
                        >
                        <button 
                            onclick="sendMessage()"
                            class="bg-gold-experience hover:bg-gold-legacy text-nexus-deep px-4 py-2 rounded-lg font-semibold transition-colors"
                        >
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/utils.js"></script>
    <script>
        let currentUser = null;
        let currentAgent = null;
        let agentsData = [];
        let conversationHistory = {};
        let apiKeys = {};

        // Menu inteligente (CTA criar agentes)
        (function(){
          function isAdmin(){
            try { return window.NexialistaAuth && typeof window.NexialistaAuth.isAdmin==='function' && window.NexialistaAuth.isAdmin(); } catch(e){ return false; }
          }
          function smartNavigate(e){ e.preventDefault(); window.location.href = isAdmin()? 'custom-agents.html' : 'admin-auth.html'; }
          document.addEventListener('DOMContentLoaded',function(){
            const a = document.getElementById('create-academy-agents-link');
            if (a) a.addEventListener('click', smartNavigate);
          });
        })();

        // Check authentication (server-first compat)
        async function checkAuth() {
            // 1) Tentar sess√£o do Auth System
            if (window.NexialistaAuth && typeof window.NexialistaAuth.isLoggedIn==='function' && window.NexialistaAuth.isLoggedIn()) {
                const u = window.NexialistaAuth.currentUser;
                currentUser = { email: u.email, subscription: u.subscription || 'basic', plan: u.subscription==='premium'?'nexus-master':u.subscription==='vip'?'nexus-infinity':'nexus-explorer' };
            }
            // 2) Fallback √Årea de Membros
            if (!currentUser) {
                const session = localStorage.getItem('nexus_member_session') || localStorage.getItem('currentUser');
                if (!session) { window.location.href = 'members.html'; return; }
                try {
                    const parsed = JSON.parse(session);
                    currentUser = {
                        email: parsed.email || parsed.user?.email,
                        subscription: parsed.subscription || parsed.user?.subscription || (parsed.plan==='nexus-master'?'premium':parsed.plan==='nexus-infinity'?'vip':'basic'),
                        plan: parsed.plan || (parsed.subscription==='premium'?'nexus-master':parsed.subscription==='vip'?'nexus-infinity':'nexus-explorer')
                    };
                } catch(e) { window.location.href='members.html'; return; }
            }
            document.getElementById('user-plan').textContent = getPlanDisplayName(currentUser.plan);
            
            // Load API keys first (await), then load agents
            await loadApiKeys();
            loadAgents();
            loadConversationHistory();
        }

        // Get plan display name
        function getPlanDisplayName(plan) {
            const planNames = {
                'nexus-explorer': 'Nexus Explorer',
                'nexus-master': 'Nexus Master',
                'nexus-infinity': 'Nexus Infinity'
            };
            return planNames[plan] || 'Plano B√°sico';
        }

        // Load conversation history from localStorage
        function loadConversationHistory() {
            const savedHistory = localStorage.getItem(`nexialista_history_${currentUser.email}`);
            if (savedHistory) {
                conversationHistory = JSON.parse(savedHistory);
            }
        }

        // Save conversation history
        function saveConversationHistory() {
            localStorage.setItem(`nexialista_history_${currentUser.email}`, JSON.stringify(conversationHistory));
        }

        // Load API keys from database
        async function loadApiKeys(){
            try {
                const response = await fetch(buildApiUrl('tables/custom_agents_api_keys'));
                if (response.ok) {
                    const keys = await response.json();
                    console.log('API Keys loaded:', keys.length, 'keys');
                    
                    // Convert array to object { provider: key }
                    apiKeys = {};
                    keys.forEach(keyData => {
                        apiKeys[keyData.provider] = keyData.api_key;
                    });
                    
                    console.log('API Keys available for:', Object.keys(apiKeys).join(', '));
                } else {
                    console.warn('Failed to load API keys, using empty object');
                    apiKeys = {};
                }
            } catch (error) {
                console.error('Error loading API keys:', error);
                apiKeys = {};
            }
        }

        // Load agents from server (server-first)
        async function loadAgents() {
            const debug = /[?&]debug=1/.test(window.location.search);
            
            // Check if there's a specific agent ID in URL
            const urlParams = new URLSearchParams(window.location.search);
            const specificAgentId = urlParams.get('agent');

            let __fetchStatus = 'pending'; let __fetchError = ''; let __path = 'relative';
            try {
                const noCache = Date.now();
                
                // If specific agent requested, load only that one
                if (specificAgentId) {
                    console.log('Loading specific agent:', specificAgentId);
                    let res = await fetch(buildApiUrl(`tables/custom_agents/${specificAgentId}?_=${noCache}`), { cache: 'no-store' });
                    __fetchStatus = `HTTP ${res.status}`;
                    
                    if (res.ok) {
                        const agent = await res.json();
                        console.log('Agent loaded:', agent);
                        agentsData = [agent];
                    } else {
                        __fetchError = await res.text();
                        console.error('Error loading agent:', __fetchError);
                        agentsData = [];
                    }
                } else {
                    // Load all agents
                    let res = await fetch(buildApiUrl(`tables/custom_agents?limit=1000&_=${noCache}`), { cache: 'no-store' });
                    if (!res.ok) {
                        __path = 'absolute';
                        res = await fetch(buildApiUrl(`/tables/custom_agents?limit=1000&_=${noCache}`), { cache: 'no-store' });
                    }
                    __fetchStatus = `HTTP ${res.status}`;
                    let list = [];
                    if (res.ok) {
                        const json = await res.json();
                        // O servidor retorna array direto, n√£o { data: [...] }
                        list = (Array.isArray(json) ? json : (json.data || [])).filter(a => a && a.product === 'academia-nexialista' && (a.is_active !== false));
                        console.log('All agents loaded:', list.length);
                    } else {
                        __fetchError = await res.text();
                    }
                    agentsData = list;
                }
                
                window.__academiaFetchDiag = { status: __fetchStatus, error: __fetchError, path: __path };
                if (debug) {
                    const banner = document.getElementById('loading-agents');
                    if (banner) banner.innerHTML = `<div class='text-xs text-yellow-300'><i class='fas fa-bug mr-1'></i>DEBUG ¬ª user=${currentUser?.email||'anon'} plan=${currentUser?.subscription||'basic'} admin=${(window.NexialistaAuth&&window.NexialistaAuth.isAdmin&&window.NexialistaAuth.isAdmin())?'true':'false'} | agentes=${agentsData.length} | fetch=${__fetchStatus} (${__path}) ${__fetchError?('‚Ä¢ '+(__fetchError.slice(0,120))):''}</div>`;
                }

                displayAgents();
            } catch (error) {
                console.error('Erro ao carregar agentes da Academia:', error);
                window.__academiaFetchDiag = { status: 'NETWORK_FAIL', error: String(error?.message||error) };
                agentsData = [];
                displayAgents();
            }
        }

        // Helpers de planos (academia)
        function normalizePlans(agent){
            const plans = Array.isArray(agent.accessiblePlans) && agent.accessiblePlans.length>0 ? agent.accessiblePlans : (agent.subscriptionLevel ? [agent.subscriptionLevel] : []);
            return Array.from(new Set((plans||[]).map(p => (p||'').toLowerCase())));
        }
        function planRank(level){ return level==='vip'?3 : level==='premium'?2 : level==='basic'?1 : 0; }
        function getMinPlan(plans=[]){ if (!plans||plans.length===0) return 'basic'; let min='vip'; plans.forEach(p=>{ if (planRank(p)<planRank(min)) min=p; }); return min; }
        function planLabel(level){ return level==='vip'?'VIP' : level==='premium'?'premium' : 'b√°sico'; }

        // Display agents with access control (server-first)
        function displayAgents() {
            const container = document.getElementById('agents-container');
            const empty = document.getElementById('empty-state');
            container.innerHTML = '';

            if (!agentsData || agentsData.length===0) {
                document.getElementById('loading-agents').style.display = 'none';
                if (empty) empty.classList.remove('hidden');
                // Mostrar CTA apenas para admin
                try {
                    const isAdmin = window.NexialistaAuth && window.NexialistaAuth.isAdmin();
                    const cta = document.getElementById('create-academy-agents-link');
                    if (cta) cta.classList.toggle('hidden', !isAdmin);
                } catch {}
                return;
            }
            if (empty) empty.classList.add('hidden');

            const userLevel = (currentUser && currentUser.subscription) || 'basic';
            agentsData.forEach(agent => {
                const plans = normalizePlans(agent);
                const canAccess = planRank(userLevel) >= planRank(getMinPlan(plans));
                const card = createAgentCard(agent, canAccess, plans);
                container.appendChild(card);
            });
            
            document.getElementById('loading-agents').style.display = 'none';
        }

        // Create agent card (Academia)
        function createAgentCard(agent, hasAccess, plans) {
            const providerName = (agent.provider||'').toLowerCase();
            const providerNice = providerName==='openrouter' ? 'OpenRouter' : providerName==='google' ? 'Google Gemini' : providerName==='anthropic' ? 'Anthropic' : providerName==='openai' ? 'OpenAI' : (agent.provider||'Prov');
            const hasKey = !!apiKeys[providerName];
            const required = getMinPlan(plans||[]);

            const card = document.createElement('div');
            card.className = `agent-card bg-nexus-power border border-gold-experience/30 rounded-xl p-6 relative ${!hasAccess ? 'locked' : ''}`;
            
            const lockIcon = hasAccess ? '<span class="text-xs text-green-400"><i class="fas fa-lock-open mr-1"></i>Dispon√≠vel</span>' : '<span class="text-xs text-red-400"><i class="fas fa-lock mr-1"></i>Bloqueado</span>';
            const btn = hasAccess && hasKey
                ? `<button onclick="openChat('${agent.id}')" class="w-full bg-gold-experience hover:bg-gold-legacy text-nexus-deep py-2 rounded-lg font-semibold transition-colors"><i class="fas fa-comments mr-2"></i>Conversar</button>`
                : `<button disabled class="w-full bg-gray-700 text-gray-500 py-2 rounded-lg font-semibold cursor-not-allowed">${!hasAccess?`<i class='fas fa-lock mr-2'></i>Acesso bloqueado`:`Configurar API (${providerNice})`}</button>`;

            card.innerHTML = `
                <div class="${!hasAccess ? 'opacity-50' : ''}">
                    <div class="flex items-start space-x-4">
                        <div class="w-12 h-12 bg-gold-experience/20 rounded-full flex items-center justify-center text-xl"> <i class="${agent.avatar||'fas fa-robot'}"></i> </div>
                        <div class="flex-1">
                            <h3 class="font-playfair font-bold text-lg text-gold-experience mb-1">${agent.name}</h3>
                            <p class="text-xs text-digital-clarity/60 mb-3">${providerNice} ‚Ä¢ ${agent.model}</p>
                            <p class="text-digital-clarity/70 text-sm mb-4">${agent.description||''}</p>
                            <div class="flex items-center justify-between mb-4">${lockIcon}</div>
                            ${btn}
                            ${!hasAccess?`<p class="mt-2 text-[11px] text-red-300"><i class='fas fa-triangle-exclamation mr-1'></i> Fa√ßa o upgrade para o plano ${planLabel(required)}.</p>`:''}
                        </div>
                    </div>
                </div>
                ${!hasAccess ? `
                    <div class="lock-overlay absolute inset-0 rounded-xl flex items-center justify-center">
                        <div class="text-center">
                            <i class="fas fa-lock text-4xl text-gold-experience/50 mb-2"></i>
                            <p class="text-sm text-digital-clarity/70">Dispon√≠vel a partir do plano:</p>
                            <p class="text-xs text-gold-experience">${planLabel(required)}</p>
                        </div>
                    </div>` : ''}
            `;
            return card;
        }

        // (Removido) Vers√£o antiga do createAgentCard baseada em localStorage ‚Äî substitu√≠da pela vers√£o server-first acima.

        // Open chat with agent
        function openChat(agentId) {
            currentAgent = agentsData.find(a => a.id === agentId);
            if (!currentAgent) return;
            
            // Update modal header
            document.getElementById('agent-name').textContent = currentAgent.name;
            (function(){
                const p = (currentAgent.provider||'').toLowerCase();
                const providerNice = p==='openrouter'?'OpenRouter':p==='google'?'Google Gemini':p==='anthropic'?'Anthropic':p==='openai'?'OpenAI':(currentAgent.provider||'IA');
                const spec = currentAgent.category || `${providerNice} ‚Ä¢ ${currentAgent.model||''}`;
                document.getElementById('agent-specialty').textContent = spec;
            })();
            document.getElementById('agent-avatar').innerHTML = `<i class="${currentAgent.avatar || 'fas fa-robot'} text-nexus-deep"></i>`;
            
            // Load previous conversation if exists
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.innerHTML = '';
            
            if (conversationHistory[agentId]) {
                conversationHistory[agentId].forEach(msg => {
                    addMessageToChat(msg.content, msg.role === 'user');
                });
            } else {
                // Initial greeting
                addMessageToChat(`Ol√°! Eu sou ${currentAgent.name}, especialista em ${currentAgent.specialty}. Como posso expandir sua consci√™ncia hoje?`, false);
            }
            
            // Show modal
            document.getElementById('chat-modal').classList.remove('hidden');
            document.getElementById('chat-input').focus();
        }

        // Close chat
        function closeChat() {
            document.getElementById('chat-modal').classList.add('hidden');
            currentAgent = null;
        }

        // Send message (real providers, prioritizing OpenRouter/Google)
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message || !currentAgent) return;
            addMessageToChat(message, true);
            input.value = '';

            if (!conversationHistory[currentAgent.id]) conversationHistory[currentAgent.id] = [];
            conversationHistory[currentAgent.id].push({ role:'user', content: message, timestamp: new Date().toISOString() });

            const typingDiv = document.createElement('div');
            typingDiv.className = 'flex justify-start mb-4 typing-message';
            typingDiv.innerHTML = `<div class="bg-nexus-power border border-gold-experience/20 rounded-lg px-4 py-2 max-w-lg"><span class="text-digital-clarity/70 typing-indicator">Pensando</span></div>`;
            document.getElementById('chat-messages').appendChild(typingDiv);
            scrollToBottom();

            try {
                const response = await callAgentAPI(currentAgent, message);
                typingDiv.remove();
                addMessageToChat(response, false);
                conversationHistory[currentAgent.id].push({ role:'assistant', content: response, timestamp: new Date().toISOString() });
                saveConversationHistory();
                updateUserStats();
            } catch (e) {
                typingDiv.remove();
                addMessageToChat('‚ùå Erro ao consultar o provedor: '+(e.message||'Falha desconhecida'), false);
            }
        }

        async function callAgentAPI(agent, userMessage){
            const provider = (agent.provider||'').toLowerCase();
            const key = apiKeys[provider];
            if (!key) throw new Error(`Chave API ausente para ${provider}`);

            let systemPrompt = agent.systemPrompt || agent.system_prompt || '';
            if (agent.knowledge) systemPrompt += `\n\nBase de Conhecimento:\n${agent.knowledge}`;

            const recent = (conversationHistory[agent.id]||[]).slice(-6);
            
            // Convert temperature and max_tokens to numbers
            const temperature = parseFloat(agent.temperature) || 0.7;
            const maxTokens = parseInt(agent.max_tokens || agent.maxTokens) || 2000;
            
            console.log('Calling API with:', { provider, model: agent.model, temperature, maxTokens });
            
            if (provider==='openai' || provider==='openrouter'){
                const endpoint = provider==='openrouter' ? 'https://openrouter.ai/api/v1/chat/completions' : 'https://api.openai.com/v1/chat/completions';
                const res = await fetch(endpoint, {
                    method:'POST',
                    headers:{
                        'Content-Type':'application/json',
                        'Authorization': `Bearer ${key}`,
                        ...(endpoint.includes('openrouter') ? { 'HTTP-Referer': window.location.href, 'X-Title': (document && document.title) ? document.title : 'Academia Nexialista' } : {})
                    },
                    body: JSON.stringify({
                        model: agent.model,
                        messages: [ {role:'system', content: systemPrompt}, ...recent, {role:'user', content: userMessage} ],
                        temperature: temperature,
                        max_tokens: maxTokens
                    })
                });
                if (!res.ok) throw new Error(`${res.status} ${await res.text()}`);
                const data = await res.json();
                return data.choices?.[0]?.message?.content || 'Resposta vazia do provedor';
            }
            if (provider==='anthropic'){
                const res = await fetch('https://api.anthropic.com/v1/messages', {
                    method:'POST', headers:{ 'Content-Type':'application/json', 'x-api-key': key, 'anthropic-version':'2023-06-01' },
                    body: JSON.stringify({ model: agent.model, max_tokens: maxTokens, temperature: temperature, system: systemPrompt, messages:[{role:'user', content:userMessage}] })
                });
                if (!res.ok) throw new Error(`${res.status} ${await res.text()}`);
                const data = await res.json();
                return data.content?.[0]?.text || 'Resposta vazia do provedor';
            }
            if (provider==='google'){
                const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/${agent.model}:generateContent?key=${key}`;
                const prompt = `${systemPrompt}\n\nUser: ${userMessage}\nAssistant:`;
                const res = await fetch(endpoint, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ contents:[{ parts:[{ text: prompt }] }], generationConfig:{ temperature: temperature, maxOutputTokens: maxTokens } }) });
                if (!res.ok) throw new Error(`${res.status} ${await res.text()}`);
                const data = await res.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || 'Resposta vazia do provedor';
            }
            if (provider==='groq'){
                const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method:'POST',
                    headers:{
                        'Content-Type':'application/json',
                        'Authorization': `Bearer ${key}`
                    },
                    body: JSON.stringify({
                        model: agent.model,
                        messages: [ {role:'system', content: systemPrompt}, ...recent, {role:'user', content: userMessage} ],
                        temperature: temperature,
                        max_tokens: maxTokens
                    })
                });
                if (!res.ok) throw new Error(`${res.status} ${await res.text()}`);
                const data = await res.json();
                return data.choices?.[0]?.message?.content || 'Resposta vazia do provedor';
            }
            throw new Error('Provedor n√£o suportado');
        }

        // Add message to chat
        function addMessageToChat(message, isUser) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${isUser ? 'justify-end' : 'justify-start'} mb-4`;
            
            messageDiv.innerHTML = `
                <div class="${isUser ? 
                    'bg-gold-experience/20 border border-gold-experience/40' : 
                    'bg-nexus-power border border-gold-experience/20'
                } rounded-lg px-4 py-2 max-w-lg">
                    <p class="text-digital-clarity">${message}</p>
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        // Scroll to bottom of chat
        function scrollToBottom() {
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Handle keypress in chat input
        function handleChatKeypress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Update user stats
        function updateUserStats() {
            const statsKey = 'userStats_' + currentUser.email;
            const stats = JSON.parse(localStorage.getItem(statsKey) || '{}');
            
            stats.totalInteractions = (stats.totalInteractions || 0) + 1;
            stats.lastInteraction = new Date().toISOString();
            stats.insightsGenerated = (stats.insightsGenerated || 0) + 1;
            
            // Calculate active days
            const today = new Date().toDateString();
            if (!stats.activeDates) stats.activeDates = [];
            if (!stats.activeDates.includes(today)) {
                stats.activeDates.push(today);
            }
            stats.activeDays = stats.activeDates.length;
            
            localStorage.setItem(statsKey, JSON.stringify(stats));
        }

        // Go back to dashboard
        function goBack() {
            window.location.href = 'members-dashboard.html';
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
        });
    </script>

    <!-- Admin FAB: acesso r√°pido ao Editor de Agentes -->
    <script>
      (function(){
        function isAdminFounder(){
          try {
            if (window.NexialistaAuth && typeof window.NexialistaAuth.isAdmin==='function' && window.NexialistaAuth.isAdmin()) return true;
            const u = window.NexialistaAuth && window.NexialistaAuth.currentUser;
            if (u && (u.role==='admin' || u.role==='founder' || u.type==='admin')) return true;
            const s = localStorage.getItem('nexialista_admin_session');
            if (s){ const sess = JSON.parse(s); if (sess && sess.expires && sess.expires > Date.now()) return true; }
          } catch(e){}
          return false;
        }
        function mountAdminFab(){
          if (!isAdminFounder()) return;
          if (document.getElementById('admin-fab-editor')) return;
          const btn = document.createElement('button');
          btn.id = 'admin-fab-editor';
          btn.className = 'fixed bottom-6 right-6 z-50 rounded-full shadow-lg bg-gold-experience text-nexus-deep w-12 h-12 flex items-center justify-center hover:bg-gold-legacy transition-colors';
          btn.title = 'Editor de Agentes';
          btn.innerHTML = '<i class="fas fa-wrench"></i>';
          btn.addEventListener('click', function(){ window.location.href = 'custom-agents.html'; });
          document.body.appendChild(btn);
        }
        document.addEventListener('DOMContentLoaded', mountAdminFab);
      })();
    </script>
</body>
</html>